<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <title>Storgate</title>
</head>
<body>
    <div class="container">
        <nav>
            <a class="nav__link" href="./index.html">About</a>
        </nav>
        <div class="form">
            <img class="form__img" src="img/main-logo-official.png" />
            <input class="search" autocomplete="off" type="text" id="searchKey">
            <select class="form__select" id="netDropdown">
                <option value="mainnet">Mainnet</option>
                <option value="ropsten">Ropsten</option>
            </select><br>
            <button class="form__button form__button-1" onclick="requestData()">Search</button>
            <button class="form__button form__button-2" onclick="requestDataAndGo()">I'm feeling lucky</button>
            <div id="searchResult" class="searchResult"></div><br>
        </div>
        
    </div>
    

    <script type="text/javascript">
        var serverUrl = "http://tnsksqdywtzhe5yrel5b5apizwhfbiqrhhmjmg66vtojkdmiascrlpyd.onion";
        let searchbar = document.getElementById("searchKey");
        searchbar.addEventListener("keydown", function(e) {
            if (e.keyCode===13) {
                requestDataAndGo();

            }
        })
        function requestData() {
            let key = document.getElementById("searchKey").value;
            let result = document.getElementById("searchResult");
            let e = document.getElementById("netDropdown");
            let net = e.options[e.selectedIndex].value;
            let requestString = "?q=" + key + "&type=complete&net=" + net;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', serverUrl + "/search" + requestString);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                    result.innerHTML = xhr.responseText;
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                    result.innerHTML = 'Request failed';
                }
            };
            xhr.send();
        }
        
        function requestDataAndGo() {
            let key = document.getElementById("searchKey").value;
            let result = document.getElementById("searchResult");
            let e = document.getElementById("netDropdown");
            let net = e.options[e.selectedIndex].value;
            let requestString = "?q=" + key + "&type=result&net=" + net;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', serverUrl + "/search" + requestString);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    result = JSON.parse(xhr.responseText);
                    console.log(result.onion);
                    if (result.onion !== "") {
                        window.open("http://" + result.onion + ".onion", '_self');
                    } else if (result.content !== "") { 
                        window.open("https://gateway.ipfs.io/ipfs/" + result.content, '_self'); 
                    } else {
                        result.innerHTML = 'No onion or IPFS addresses specified';
                    }
        
                } else {
                    console.log('Request failed.  Returned status of ' + xhr.status);
                    result.innerHTML = 'Request failed';
                }
            };
            xhr.send();
        }
        </script>
</body>

</html>
